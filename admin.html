<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì íŒ¨ë„</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ” ê´€ë¦¬ì íŒ¨ë„</h1>
            <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </header>

        <div class="admin-panel">
            <h2>í™•ì¥ì ê´€ë¦¬</h2>
            <div class="form-group">
                <input type="text" id="new-ext" placeholder="í™•ì¥ì (ì˜ˆ: .example.com)">
                <input type="number" id="ext-price" placeholder="ê°€ê²© (0=ë¬´ë£Œ)" min="0">
                <input type="url" id="payment-url" placeholder="ê²°ì œ ë§í¬ (ì„ íƒ)">
                <button onclick="addExtension()">ì¶”ê°€</button>
            </div>
            <div id="ext-list"></div>
        </div>

        <div class="admin-panel">
            <h2>ê²°ì œ ìŠ¹ì¸ ëŒ€ê¸°</h2>
            <div id="pending-payments"></div>
        </div>

        <div class="admin-panel">
            <h2>ë³´ì•ˆ ë´‡ ì„¤ì •</h2>
            <div class="form-group">
                <input type="time" id="bot-start" value="00:00">
                <input type="time" id="bot-end" value="23:59">
                <button onclick="updateBotSchedule()">ì ìš©</button>
            </div>
            <p>í˜„ì¬ ì‹œê°„: <span id="current-time"></span> (KST)</p>
            <p>ë³´ì•ˆ ë´‡ ìƒíƒœ: <span id="bot-status">í™œì„±</span></p>
        </div>

        <div class="admin-panel">
            <h2>ì‚¬ìš©ì ê´€ë¦¬</h2>
            <div id="user-list"></div>
        </div>

        <div class="admin-panel">
            <h2>ë³´ì•ˆ ë¡œê·¸</h2>
            <div id="security-logs"></div>
        </div>
    </div>

    <script>
        let currentUser = null;

        async function init() {
            const user = localStorage.getItem('currentUser');
            if (!user) {
                window.location.href = '/';
                return;
            }
            currentUser = JSON.parse(user);
            if (currentUser.username !== 'admindomain') {
                window.location.href = '/';
                return;
            }
            
            loadExtensions();
            loadPendingPayments();
            loadUsers();
            loadSecurityLogs();
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
        }

        function updateCurrentTime() {
            const now = new Date();
            const kstTime = new Date(now.toLocaleString('en-US', {timeZone: 'Asia/Seoul'}));
            document.getElementById('current-time').textContent = kstTime.toLocaleTimeString('ko-KR');
        }

        async function addExtension() {
            const name = document.getElementById('new-ext').value.trim();
            const price = parseFloat(document.getElementById('ext-price').value) || 0;
            const paymentUrl = document.getElementById('payment-url').value.trim();

            if (!name) {
                alert('í™•ì¥ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }

            if (!name.startsWith('.')) {
                alert('í™•ì¥ìëŠ” .ìœ¼ë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤');
                return;
            }

            try {
                const res = await fetch('/api/domains', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        action: 'addExtension',
                        username: currentUser.username,
                        name, price, paymentUrl
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('í™•ì¥ìê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
                    document.getElementById('new-ext').value = '';
                    document.getElementById('ext-price').value = '';
                    document.getElementById('payment-url').value = '';
                    loadExtensions();
                } else {
                    alert(data.message || 'ì‹¤íŒ¨');
                }
            } catch (e) {
                alert('ì˜¤ë¥˜ ë°œìƒ');
            }
        }

        async function loadExtensions() {
            try {
                const res = await fetch('/api/domains?action=getExtensions');
                const data = await res.json();
                
                const list = document.getElementById('ext-list');
                list.innerHTML = '<table><tr><th>í™•ì¥ì</th><th>ê°€ê²©</th><th>ê²°ì œë§í¬</th><th>ì‘ì—…</th></tr>' +
                    data.extensions.map(e => `
                        <tr>
                            <td>${e.name}</td>
                            <td>â‚©${e.price}</td>
                            <td>${e.paymentUrl || '-'}</td>
                            <td><button onclick="deleteExtension('${e.name}')">ì‚­ì œ</button></td>
                        </tr>
                    `).join('') + '</table>';
            } catch (e) {
                console.error(e);
            }
        }

        async function deleteExtension(name) {
            if (!confirm(`${name} í™•ì¥ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            try {
                const res = await fetch('/api/domains', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        action: 'deleteExtension',
                        username: currentUser.username,
                        name
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                    loadExtensions();
                }
            } catch (e) {
                alert('ì˜¤ë¥˜ ë°œìƒ');
            }
        }

        async function loadPendingPayments() {
            try {
                const res = await fetch('/api/domains?action=getPendingPayments');
                const data = await res.json();
                
                const div = document.getElementById('pending-payments');
                if (data.payments.length === 0) {
                    div.innerHTML = '<p>ëŒ€ê¸°ì¤‘ì¸ ê²°ì œê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                } else {
                    div.innerHTML = '<table><tr><th>ì‚¬ìš©ì</th><th>ë„ë©”ì¸</th><th>ê°€ê²©</th><th>ì‘ì—…</th></tr>' +
                        data.payments.map(p => `
                            <tr>
                                <td>${p.username}</td>
                                <td>${p.domain}</td>
                                <td>â‚©${p.price}</td>
                                <td>
                                    <button onclick="approvePayment('${p.domain}')">ìŠ¹ì¸</button>
                                    <button onclick="rejectPayment('${p.domain}')">ê±°ë¶€</button>
                                </td>
                            </tr>
                        `).join('') + '</table>';
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function approvePayment(domain) {
            try {
                const res = await fetch('/api/domains', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        action: 'approvePayment',
                        username: currentUser.username,
                        domain
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤');
                    loadPendingPayments();
                }
            } catch (e) {
                alert('ì˜¤ë¥˜ ë°œìƒ');
            }
        }

        async function rejectPayment(domain) {
            try {
                const res = await fetch('/api/domains', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        action: 'rejectPayment',
                        username: currentUser.username,
                        domain
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤');
                    loadPendingPayments();
                }
            } catch (e) {
                alert('ì˜¤ë¥˜ ë°œìƒ');
            }
        }

        async function loadUsers() {
            try {
                const res = await fetch('/api/domains?action=getAllUsers');
                const data = await res.json();
                
                const div = document.getElementById('user-list');
                div.innerHTML = '<table><tr><th>ì‚¬ìš©ìëª…</th><th>ì´ë©”ì¼</th><th>ìƒíƒœ</th><th>ì‘ì—…</th></tr>' +
                    data.users.map(u => `
                        <tr>
                            <td>${u.username}</td>
                            <td>${u.email}</td>
                            <td><span class="status-badge status-${u.status}">${u.status}</span></td>
                            <td>
                                ${u.status !== 'suspended' ? `<button onclick="suspendUser('${u.username}')">ì •ì§€</button>` : ''}
                                ${u.status === 'suspended' ? `<button onclick="unsuspendUser('${u.username}')">í•´ì œ</button>` : ''}
                                <button onclick="blacklistUser('${u.username}')">ë¸”ë™ë¦¬ìŠ¤íŠ¸</button>
                            </td>
                        </tr>
                    `).join('') + '</table>';
            } catch (e) {
                console.error(e);
            }
        }

        async function suspendUser(username) {
            if (!confirm(`${username}ë¥¼ ì •ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            try {
                const res = await fetch('/api/domains', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        action: 'suspendUser',
                        username: currentUser.username,
                        targetUser: username
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤');
                    loadUsers();
                }
            } catch (e) {
                alert('ì˜¤ë¥˜ ë°œìƒ');
            }
        }

        async function unsuspendUser(username) {
            try {
                const res = await fetch('/api/domains', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        action: 'unsuspendUser',
                        username: currentUser.username,
                        targetUser: username
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                    loadUsers();
                }
            } catch (e) {
                alert('ì˜¤ë¥˜ ë°œìƒ');
            }
        }

        async function blacklistUser(username) {
            if (!confirm(`${username}ë¥¼ ë¸”ë™ë¦¬ìŠ¤íŠ¸ì— ë“±ì¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            try {
                const res = await fetch('/api/domains', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        action: 'blacklistUser',
                        username: currentUser.username,
                        targetUser: username
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('ë¸”ë™ë¦¬ìŠ¤íŠ¸ì— ë“±ì¬ë˜ì—ˆìŠµë‹ˆë‹¤');
                    loadUsers();
                }
            } catch (e) {
                alert('ì˜¤ë¥˜ ë°œìƒ');
            }
        }

        async function updateBotSchedule() {
            const start = document.getElementById('bot-start').value;
            const end = document.getElementById('bot-end').value;

            try {
                const res = await fetch('/api/domains', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        action: 'updateBotSchedule',
                        username: currentUser.username,
                        start, end
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('ë³´ì•ˆ ë´‡ ìŠ¤ì¼€ì¤„ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤');
                }
            } catch (e) {
                alert('ì˜¤ë¥˜ ë°œìƒ');
            }
        }

        async function loadSecurityLogs() {
            try {
                const res = await fetch('/api/domains?action=getSecurityLogs');
                const data = await res.json();
                
                const div = document.getElementById('security-logs');
                if (data.logs.length === 0) {
                    div.innerHTML = '<p>ë³´ì•ˆ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                } else {
                    div.innerHTML = '<table><tr><th>ì‹œê°„</th><th>ìœ í˜•</th><th>ì‚¬ìš©ì</th><th>ì„¤ëª…</th></tr>' +
                        data.logs.slice(-20).reverse().map(l => `
                            <tr>
                                <td>${new Date(l.timestamp).toLocaleString('ko-KR')}</td>
                                <td>${l.type}</td>
                                <td>${l.username}</td>
                                <td>${l.description}</td>
                            </tr>
                        `).join('') + '</table>';
                }
            } catch (e) {
                console.error(e);
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = '/';
        }

        window.onload = init;
        setInterval(loadSecurityLogs, 10000);
    </script>
</body>
</html>
